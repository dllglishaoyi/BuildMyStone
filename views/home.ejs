<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='/plugins/ligrid/ligrid.css' />
</head>
<body>
    <input type="search" id="search">
    <button id="searchBtn">搜索</button>
    <div id="ligrid">
    </div>
    <button id="goBtn">推荐卡组</button>
    <div id="decks-area">

    </div>
    <script src="/javascripts/zepto.min.js"></script>
    <script src="/plugins/ligrid/ligrid.js"></script>
    <script type="text/javascript">
        var cards = <%- JSON.stringify(cards)%>;

        var ligrid = new Ligrid({countPerpage:20,gridid:"ligrid"});
        ligrid.loadData(cards);
        document.getElementById("searchBtn").addEventListener("click",function(e){
            var keyword = document.getElementById('search').value;
            if (keyword) {
                var newcards = cards.filter(function(item) {
                    return item.name.indexOf(keyword) > -1;
                });
                ligrid.loadData(newcards);
            }else{
                ligrid.loadData(cards);
            }
        });
        document.getElementById("goBtn").addEventListener("click",function(e){
            // ligrid.showData();
            // console.log(ligrid.getSelectedData());
            var cardsdata = ligrid.getSelectedData();
            var postData = { cards: cardsdata };
            $.ajax({
              type: 'POST',
              url: '/getrecommenddecks',
              // data to be added to query string:
              data: postData,
              // type of data we are expecting in return:
              dataType: 'json',
              timeout: 15000,
              success: function(data){
                console.log(data);
                showDecks(data);
              },
              error: function(xhr, type){
                alert('Ajax error!')
              }
            });
        });
        function showDecks(decks){
            var decksArea = document.getElementById("decks-area");
            decksArea.innerHTML = "";
            for (var i = 0; i < decks.length; i++) {
                addDeck(decks[i]);
            };
        }
        function addDeck(deck){
            var deckList = document.createElement("ul");
            deckList.className = "deck";
            var deckHeader = document.createElement("li");
            deckHeader.innerHTML = "相似度："+deck.percent;
            deckList.appendChild(deckHeader);
            for (var i = 0; i < deck.originalDeck.length; i++) {
                var cardItem = document.createElement("li");
                var flag = false;
                var a = deck.sameCards.indexOf(deck.originalDeck[i].cardName);
                if (a >=0) {
                    deck.sameCards.splice(a, 1); 
                    flag = true;
                };
                cardItem.innerHTML = deck.originalDeck[i].cardName + (flag ? "(您有)" : '');
                deckList.appendChild(cardItem);
            };
            var decksArea = document.getElementById("decks-area");
            decksArea.appendChild(deckList);
        }
    </script>
</body>
</html>